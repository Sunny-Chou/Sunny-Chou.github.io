<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>學生作業管理系統</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        select,
        input {
            color: rgb(75, 54, 118);
            height: 50px;
            width: 200px;
            border-radius: 30px;
            border: 3px solid rgb(75, 54, 118);
            font-size: 20px;
            font-family: 微軟正黑體;
            font-weight: bold;
            margin: 10px;
            padding-left: 10px;
            padding-right: 10px;
        }

        button {
            width: 150px;
            height: 50px;
            border-radius: 30px;
            border: 3px solid rgb(75, 54, 118);
            font-size: 20px;
            font-family: 微軟正黑體;
            font-weight: bold;
            margin: 10px;
            background-color: white;
            color: rgb(75, 54, 118);
        }

        button:hover {
            background-color: rgb(75, 54, 118);
            color: white;
        }

        label {
            color: rgb(75, 54, 118);
            font-weight: bold;
            font-size: 20px;
        }

        input:focus {
            background-color: rgb(75, 54, 118);
            color: white;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
</head>

<body>
    <div style="text-align: center;">
        <div style="display: flex; align-items: center; flex-direction: column;">
            <div style="display: flex; align-items: center;">
                <label>操作：</label>
                <select id="op">
                    <option>新增學生</option>
                    <option>新增作業</option>
                    <option>刪除學生</option>
                    <option>刪除作業</option>
                </select>
            </div>
            <div id="classnamediv" style="display: flex; align-items: center;">
                <label>班級：</label>
                <select id="classname"></select>
            </div>
            <div id="namediv" style="display: flex; align-items: center;">
                <label>姓名：</label>
                <select id="name"></select>
            </div>
            <div id="typediv" style="display: flex; align-items: center;">
                <label>科目：</label>
                <select id="type"></select>
            </div>
            <div id="homeworkdiv" style="display: flex; align-items: center;">
                <label>作業：</label>
                <select id="homework"></select>
            </div>
            <div id="classnamediv2" style="display: flex; align-items: center;">
                <label>請選擇班級：</label>
                <select id="classname2"></select>
            </div>
            <div id="cndiv" style="display: flex; align-items: center;">
                <label>請輸入班級：</label>
                <input id="cn" type="text">
            </div>
            <div id="ndiv" style="display: flex; align-items: center;">
                <label>請輸入姓名：</label>
                <input id="n" type="text">
            </div>
            <div id="typediv2" style="display: flex; align-items: center;">
                <label>請選擇科目：</label>
                <select id="type2"></select>
            </div>
            <div id="tdiv" style="display: flex; align-items: center;">
                <label>請輸入科目：</label>
                <input id="t" type="text">
            </div>
            <div id="hwndiv" style="display: flex; align-items: center;">
                <label>請輸入作業名稱：</label>
                <input id="hwn" type="text">
            </div>
            <div id="hwtdiv" style="display: flex; align-items: center;">
                <label>請輸入單位：</label>
                <input id="hwt" type="text" maxlength="1">
                <label>請選擇單位種類：</label>
                <select id="hwrn">
                    <option>範圍</option>
                    <option>數量</option>
                </select>
            </div>
            <div style="display: flex; align-items: center;">
                <button id="no">刪除</button>
                <button id="ok">新增</button>
            </div>
        </div>
        <div style="display: flex; align-items: center; flex-direction: column;">
            <div style="display: flex; align-items: center;">
                <label id="show"></label>
            </div>
        </div>
    </div>
    <script>
        var url = "https://script.google.com/macros/s/AKfycbzIwxS8INYgGOys_7Ww5pia1Esd0ncSYCBXPNN8rT0crWmQsxcEM0nprDQWq5_1DqvHwg/exec";
        var stuurl = "https://script.google.com/macros/s/AKfycbyWY69K8OpTj5laSoubzcOwBqgOR9yADinFNUFdbvxFYB7M6oQWtIXfWPY7wqwrVTWAfQ/exec";
        var hwurl = "https://script.google.com/macros/s/AKfycbzf6kznWJNmu6dXpKleFVzOLYfP2EZYQ9RwDwj_cx2mnxNYDBIWMExq0Xl37LkhBt1-/exec";
        var studata;//學生全部
        var hwdata;//作業全部
        var stu;//選中班級學生列表
        var hwtype;//作業名稱列表
        let hwt = [];//作業是範圍還是數字
        var isaction = true;
        $(document).ready(function () {
            const expirationTimeInMilliseconds = 600000;
            let timer;
            function resetTimer() {
                clearTimeout(timer);
                timer = setTimeout(function () {
                    sessionStorage.removeItem('登入');
                }, expirationTimeInMilliseconds);
            }
            document.addEventListener('mousemove', resetTimer);
            document.addEventListener('keypress', resetTimer);
            document.addEventListener('touchstart', resetTimer);
            resetTimer();
            $("#classnamediv").hide();
            $("#classnamediv2").hide();
            $("#namediv").hide();
            $("#typediv").hide();
            $("#typediv2").hide();
            $("#homeworkdiv").hide();
            $("#cndiv").hide();
            $("#ndiv").hide();
            $("#tdiv").hide();
            $("#hwndiv").hide();
            $("#hwtdiv").hide();
            $("#no").hide();
            $("#ok").hide();
            axios.get(url).then(({ data }) => {
                var account = sessionStorage.getItem("登入");
                var s = true;
                for (var i = 0; i < data.length; i++) {
                    if (data[i].account == account) {
                        s = false;
                        break;
                    }
                }
                if (s) {
                    sessionStorage.removeItem('登入');
                    alert("逾時沒有操作，請重新登入");
                    window.location = "index.html";
                }
                axios.get(stuurl).then(({ data }) => {
                    studata = data;
                    axios.get(hwurl).then(({ data }) => {
                        hwdata = data;
                        var options = hwdata.map(row => row.classname).slice(1);
                        options.forEach(function (option) {
                            var optionElement = document.createElement("option");
                            optionElement.text = option;
                            $('#classname').append(optionElement);
                        });
                        options.forEach(function (option) {
                            var optionElement = document.createElement("option");
                            optionElement.text = option;
                            $('#classname2').append(optionElement);
                        });
                        var optionElement = document.createElement("option");
                        optionElement.text = "其他";
                        $('#classname2').append(optionElement);
                        if ($("#classname2 option:selected").text().toString() == "其他") {
                            $("#cndiv").show();
                        } else {
                            $("#cndiv").hide();
                        }
                        options = studata.filter(row => row.classname.toString() === $('#classname option:selected').text().toString()).map(row => row.name);
                        options.forEach(function (option) {
                            var optionElement = document.createElement("option");
                            optionElement.text = option;
                            $('#name').append(optionElement);
                        });
                        hwtype = hwdata[0].homework;
                        var temp = hwtype[0].slice(0, 1);
                        options = [temp];
                        for (var i = 0; i < hwtype.length; i++) {
                            hwt.push(hwtype[i].slice(-1));
                            hwtype[i] = hwtype[i].slice(0, -1);
                            if (temp != hwtype[i].slice(0, 1)) {
                                temp = hwtype[i].slice(0, 1);
                                options.push(temp);
                            }
                        }
                        options.forEach(function (option) {
                            var optionElement = document.createElement("option");
                            optionElement.text = option;
                            $('#type').append(optionElement);
                        });
                        options.forEach(function (option) {
                            var optionElement = document.createElement("option");
                            optionElement.text = option;
                            $('#type2').append(optionElement);
                        });
                        var optionElement = document.createElement("option");
                        optionElement.text = "其他";
                        $('#type2').append(optionElement);
                        options = hwtype.filter(row => row.includes($('#type option:selected').text().toString()));
                        options.forEach(function (option) {
                            var optionElement = document.createElement("option");
                            optionElement.text = option.slice(1, -1);
                            $('#homework').append(optionElement);
                        });
                        stu = studata.filter(row => row.classname.toString() === $('#classname option:selected').text().toString());
                        $("#classname").change(function () {
                            stu = studata.filter(row => row.classname.toString() === $('#classname option:selected').text().toString());
                            options = stu.map(row => row.name);
                            $("#name").empty();
                            options.forEach(function (option) {
                                var optionElement = document.createElement("option");
                                optionElement.text = option;
                                $('#name').append(optionElement);
                            });
                        });
                        $("#classname2").change(function () {
                            if ($("#classname2 option:selected").text().toString() == "其他") {
                                $("#cndiv").show();
                            } else {
                                $("#cndiv").hide();
                            }
                        });
                        $("#type").change(function () {
                            $("#homework").empty();
                            options = hwtype.filter(row => row.includes($('#type option:selected').text().toString()));
                            options.forEach(function (option) {
                                var optionElement = document.createElement("option");
                                optionElement.text = option.slice(1, -1);
                                $('#homework').append(optionElement);
                            });
                        });
                        $("#type2").change(function () {
                            if ($("#type2 option:selected").text().toString() == "其他") {
                                $("#tdiv").show();
                            } else {
                                $("#tdiv").hide();
                            }
                        });
                        if ($('#op option:selected').text().toString() == "新增學生") {
                            $("#classnamediv").hide();
                            $("#classnamediv2").show();
                            $("#namediv").hide();
                            $("#typediv").hide();
                            $("#typediv2").hide();
                            $("#homeworkdiv").hide();
                            if ($("#classname2 option:selected").text().toString() == "其他") {
                                $("#cndiv").show();
                            } else {
                                $("#cndiv").hide();
                            }
                            $("#ndiv").show();
                            $("#tdiv").hide();
                            $("#hwndiv").hide();
                            $("#hwtdiv").hide();
                            $("#no").hide();
                            $("#ok").show();
                        } else if ($('#op option:selected').text().toString() == "新增作業") {
                            $("#classnamediv").hide();
                            $("#classnamediv2").hide();
                            $("#namediv").hide();
                            $("#typediv").hide();
                            $("#typediv2").show();
                            $("#homeworkdiv").hide();
                            $("#cndiv").hide();
                            $("#ndiv").hide();
                            if ($("#type2 option:selected").text().toString() == "其他") {
                                $("#tdiv").show();
                            } else {
                                $("#tdiv").hide();
                            }
                            $("#hwndiv").show();
                            $("#hwtdiv").show();
                            $("#no").hide();
                            $("#ok").show();
                        } else if ($('#op option:selected').text().toString() == "刪除學生") {
                            $("#classnamediv").show();
                            $("#classnamediv2").hide();
                            $("#namediv").show();
                            $("#typediv").hide();
                            $("#typediv2").hide();
                            $("#homeworkdiv").hide();
                            $("#cndiv").hide();
                            $("#ndiv").hide();
                            $("#tdiv").hide();
                            $("#hwndiv").hide();
                            $("#hwtdiv").hide();
                            $("#no").show();
                            $("#ok").hide();
                        } else if ($('#op option:selected').text().toString() == "刪除作業") {
                            $("#classnamediv").hide();
                            $("#classnamediv2").hide();
                            $("#namediv").hide();
                            $("#typediv").show();
                            $("#typediv2").hide();
                            $("#homeworkdiv").show();
                            $("#cndiv").hide();
                            $("#ndiv").hide();
                            $("#tdiv").hide();
                            $("#hwndiv").hide();
                            $("#hwtdiv").hide();
                            $("#no").show();
                            $("#ok").hide();
                        }
                        $("#op").change(function () {
                            if ($('#op option:selected').text().toString() == "新增學生") {
                                $("#classnamediv").hide();
                                $("#classnamediv2").show();
                                $("#namediv").hide();
                                $("#typediv").hide();
                                $("#typediv2").hide();
                                $("#homeworkdiv").hide();
                                if ($("#classname2 option:selected").text().toString() == "其他") {
                                    $("#cndiv").show();
                                } else {
                                    $("#cndiv").hide();
                                }
                                $("#ndiv").show();
                                $("#tdiv").hide();
                                $("#hwndiv").hide();
                                $("#hwtdiv").hide();
                                $("#no").hide();
                                $("#ok").show();
                            } else if ($('#op option:selected').text().toString() == "新增作業") {
                                $("#classnamediv").hide();
                                $("#classnamediv2").hide();
                                $("#namediv").hide();
                                $("#typediv").hide();
                                $("#typediv2").show();
                                $("#homeworkdiv").hide();
                                $("#cndiv").hide();
                                $("#ndiv").hide();
                                if ($("#type2 option:selected").text().toString() == "其他") {
                                    $("#tdiv").show();
                                } else {
                                    $("#tdiv").hide();
                                }
                                $("#hwndiv").show();
                                $("#hwtdiv").show();
                                $("#no").hide();
                                $("#ok").show();
                            } else if ($('#op option:selected').text().toString() == "刪除學生") {
                                $("#classnamediv").show();
                                $("#classnamediv2").hide();
                                $("#namediv").show();
                                $("#typediv").hide();
                                $("#typediv2").hide();
                                $("#homeworkdiv").hide();
                                $("#cndiv").hide();
                                $("#ndiv").hide();
                                $("#tdiv").hide();
                                $("#hwndiv").hide();
                                $("#hwtdiv").hide();
                                $("#no").show();
                                $("#ok").hide();
                            } else if ($('#op option:selected').text().toString() == "刪除作業") {
                                $("#classnamediv").hide();
                                $("#classnamediv2").hide();
                                $("#namediv").hide();
                                $("#typediv").show();
                                $("#typediv2").hide();
                                $("#homeworkdiv").show();
                                $("#cndiv").hide();
                                $("#ndiv").hide();
                                $("#tdiv").hide();
                                $("#hwndiv").hide();
                                $("#hwtdiv").hide();
                                $("#no").show();
                                $("#ok").hide();
                            }
                        });
                        $("#no").click(function () {
                            axios.get(url).then(({ data }) => {
                                var account = sessionStorage.getItem("登入");
                                var s = true;
                                for (var i = 0; i < data.length; i++) {
                                    if (data[i].account == account) {
                                        s = false;
                                        break;
                                    }
                                }
                                if (s) {
                                    sessionStorage.removeItem('登入');
                                    alert("逾時沒有操作，請重新登入");
                                    window.location = "index.html";
                                }
                                if (isaction) {
                                    isaction = false;
                                    var postData = new FormData();
                                    postData.append('op', $("#op option:selected").text().toString());
                                    if ($("#op option:selected").text().toString() == "刪除學生") {
                                        postData.append('classname', $("#classname option:selected").text().toString());
                                        postData.append('name', $("#name option:selected").text().toString());
                                        axios.post(stuurl, postData).then(({ data }) => {
                                            alert("刪除成功！");
                                            location.reload();
                                        })
                                            .catch(error => {
                                                isaction = true;
                                                alert("刪除失敗！");
                                            });
                                    } else {
                                        postData.append('deletehw', $("#type option:selected").text().toString() + $("#homework option:selected").text().toString() + hwt[hwtype.indexOf($("#type option:selected").text().toString() + $("#homework option:selected").text().toString())]);
                                        axios.post(hwurl, postData).then(({ data }) => {
                                            alert("刪除成功！");
                                            location.reload();
                                        })
                                            .catch(error => {
                                                isaction = true;
                                                alert("刪除失敗！");
                                            });
                                    }
                                }
                            });

                        });
                        $("#ok").click(function () {
                            axios.get(url).then(({ data }) => {
                                var account = sessionStorage.getItem("登入");
                                var s = true;
                                for (var i = 0; i < data.length; i++) {
                                    if (data[i].account == account) {
                                        s = false;
                                        break;
                                    }
                                }
                                if (s) {
                                    sessionStorage.removeItem('登入');
                                    alert("逾時沒有操作，請重新登入");
                                    window.location = "index.html";
                                }
                                if (isaction) {
                                    isaction = false;
                                    var postData = new FormData();
                                    postData.append('op', $("#op option:selected").text().toString());
                                    if ($("#op option:selected").text().toString() == "新增學生") {
                                        if ($("#classname2 option:selected").text().toString() == "其他") {
                                            if ($("#cn").val().toString() == "") {
                                                alert("班級不能是空值");
                                                isaction = true;
                                                return;
                                            }
                                            postData.append('classname', $("#cn").val());
                                        } else {
                                            if ($("#classname2 option:selected").text().toString() == "") {
                                                alert("班級不能是空值");
                                                isaction = true;
                                                return;
                                            }
                                            postData.append('classname', $("#classname2 option:selected").text().toString());
                                        }
                                        if ($("#n").val().toString() == "") {
                                            alert("姓名不能是空值");
                                            isaction = true;
                                            return;
                                        }
                                        postData.append('name', $("#n").val());
                                        axios.post(stuurl, postData).then(({ data }) => {
                                            alert("新增成功！");
                                            location.reload();
                                        })
                                            .catch(error => {
                                                isaction = true;
                                                alert("新增失敗！");
                                            });
                                    } else {
                                        var newhw = $("#hwn").val().toString();
                                        if ($("#hwn").val().toString() == "") {
                                            alert("作業名稱不能是空值");
                                            isaction = true;
                                            return;
                                        }
                                        if ($("#type2 option:selected").text().toString() == "其他") {
                                            if ($("#t").val().toString() == "") {
                                                alert("單位不能是空值");
                                                isaction = true;
                                                return;
                                            }
                                            newhw = $("#t").val().toString() + newhw;
                                            postData.append('type', $("#t").val().toString());
                                        } else {
                                            if ($("#type2 option:selected").text().toString() == "") {
                                                alert("單位不能是空值");
                                                isaction = true;
                                                return;
                                            }
                                            newhw = $("#type2 option:selected").text().toString() + newhw;
                                            postData.append('type', $("#type2 option:selected").text().toString());
                                        }
                                        newhw = newhw + "(" + $("#hwt").val().toString() + ")";
                                        if ($("#hwrn option:selected").text().toString() == "範圍") {
                                            newhw = newhw + "r";
                                        } else if ($("#hwrn option:selected").text().toString() == "數量") {
                                            newhw = newhw + "n";
                                        }
                                        postData.append('homework', newhw);
                                        axios.post(hwurl, postData).then(({ data }) => {
                                            alert("新增成功！");
                                            location.reload();
                                        })
                                            .catch(error => {
                                                isaction = true;
                                                alert("新增失敗！");
                                            });
                                    }
                                }
                            });

                        });
                    });
                });
            });
        });
    </script>

</body>

</html>