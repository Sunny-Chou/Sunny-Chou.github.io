<!DOCTYPE html>
<html>

<head>
    <title>作業管理系統</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>

    <table id="t">
        <thead>
            <tr>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
    <script>
        var url = "https://script.google.com/macros/s/AKfycbzIwxS8INYgGOys_7Ww5pia1Esd0ncSYCBXPNN8rT0crWmQsxcEM0nprDQWq5_1DqvHwg/exec";
        var stuurl = "https://script.google.com/macros/s/AKfycbyWY69K8OpTj5laSoubzcOwBqgOR9yADinFNUFdbvxFYB7M6oQWtIXfWPY7wqwrVTWAfQ/exec";
        var hwurl = "https://script.google.com/macros/s/AKfycbzf6kznWJNmu6dXpKleFVzOLYfP2EZYQ9RwDwj_cx2mnxNYDBIWMExq0Xl37LkhBt1-/exec";
        var hwdata;
        var studata;
        var hwtype;
        var hwt = [];
        const expirationTimeInMilliseconds = 600000;
        let timer;
        function resetTimer() {
            clearTimeout(timer);
            timer = setTimeout(function () {
                sessionStorage.removeItem('登入');
            }, expirationTimeInMilliseconds);
        }
        document.addEventListener('mousemove', resetTimer);
        document.addEventListener('keypress', resetTimer);
        document.addEventListener('touchstart', resetTimer);
        resetTimer();
        axios.get(url).then(({ data }) => {
            var account = sessionStorage.getItem("登入");
            var s = true;
            for (var i = 0; i < data.length; i++) {
                if (data[i].account == account) {
                    s = false;
                    break;
                }
            }
            if (s) {
                sessionStorage.removeItem('登入');
                alert("逾時沒有操作，請重新登入");
                window.location = "index.html";
            }
            axios.get(stuurl).then(({ data }) => {
                studata = data;
                axios.get(hwurl).then(({ data }) => {
                    hwdata = data;
                    hwtype = hwdata[0].homework;
                    var temp = hwtype[0].slice(0, 1);
                    var columnNames = ['班級', '姓名', temp];
                    hwt.push(temp);
                    for (var i = 0; i < hwtype.length; i++) {
                        hwtype[i] = hwtype[i].slice(0, -1);
                        if (temp != hwtype[i].slice(0, 1)) {
                            temp = hwtype[i].slice(0, 1);
                            columnNames.push(temp);
                            hwt.push(temp)
                        }
                    }
                    columnNames.push("備註");
                    studata = studata.map((subArray, index) => {
                        var hw = hwdata.filter(row => row.classname == subArray.classname)[0].homework;
                        subArray.homework = subArray.homework.map((element, i) => hw[i].toString() == "0" ? -1 : element);
                        return subArray;
                    });
                    studata = studata.map(subArray => {
                        subArray.homework = subArray.homework.filter(element => element != -1);
                        return subArray;
                    });
                    hwdata = hwdata.slice(1).map((subArray) => {
                        subArray.homework.forEach((element, i) => {
                            if (element.toString() !== "0") {
                                subArray.homework[i] = hwtype[i] + subArray.homework[i];
                            }
                        });
                        return subArray;
                    });
                    hwdata = hwdata.map(subArray => {
                        subArray.homework = subArray.homework.filter(element => element != 0);
                        return subArray;
                    });
                    var thead = document.querySelector("#t thead");
                    var tr = document.createElement("tr");
                    columnNames.forEach(function (name) {
                        var th = document.createElement("th");
                        th.textContent = name;
                        tr.appendChild(th);
                    });
                    thead.appendChild(tr);
                    // 獲取表格的 tbody 元素
                    var tbody = document.querySelector("#t tbody");
                    var stus = [...new Set(studata.map(row => row.classname).slice(1))];
                    // 遍歷數據，動態生成表格內容
                    stus.forEach(function (item, index) {
                        var chw = hwdata.filter(row => row.classname == item)[0];
                        var cname = studata.filter(row => row.classname == item);
                        // 創建新的行元素
                        var row = document.createElement("tr");
                        // 如果是每班的第一個學生，則在班級列中添加 rowspan 屬性
                        if (index === 0 || item !== studata[index - 1].classname) {
                            var totalHomeworkCount = hwt.map((hw) => {
                                // 计算当前 homework 中包含 hw 中任一字符串的数量
                                const count = chw.homework.reduce((num, str) => {
                                    if (str[0].includes(hw)) {
                                        return num + 1;
                                    }
                                    return num;
                                }, 0);
                                if (count == 0)
                                    return 1;
                                return count;
                            }).reduce((max, count) => Math.max(max, count), 0);
                            totalHomeworkCount *= cname.length;
                            var classCell = document.createElement("td");
                            classCell.textContent = item;
                            classCell.setAttribute("rowspan", totalHomeworkCount);
                            row.appendChild(classCell);
                        }
                        var rows = [row];
                        var index = 0;
                        cname.forEach(function (name, indexs) {
                            var rowspans = hwt.map(row => {
                                var nums = chw.homework.reduce((num, r) => {
                                    if (r[0].includes(row)) {
                                        return num + 1;
                                    } else {
                                        return num;
                                    }
                                }, 0);
                                if (nums == 0)
                                    return 1;
                                return nums;
                            });
                            var rowspan = rowspans.reduce((max, count) => Math.max(max, count), 0);
                            var nameCell = document.createElement("td");
                            nameCell.textContent = name.name;
                            nameCell.setAttribute("rowspan", rowspan);
                            rows[index].appendChild(nameCell);
                            for (var i = 0; i < hwt.length; i++) {
                                var hw = chw.homework.filter(row => row[0].includes(hwt[i]));
                                var hwstate = name.homework.filter((row,index)=>chw.homework[index][0].includes(hwt[i]));
                                var index2 = index;
                                for (var j = 0; j < hw.length; j++) {
                                    var hwCell = document.createElement("td");
                                    hwCell.textContent = hw[j].slice(1);
                                    if (hwstate[j].toString() == "0") {
                                        hwCell.textContent += "(未檢查)";
                                    } else if (hwstate[j].toString() == "1") {
                                        hwCell.textContent += "(檢查不OK)";
                                    } else {
                                        hwCell.textContent += "(已檢查OK)";
                                    }
                                    if (j == hw.length - 1)
                                        hwCell.setAttribute("rowspan", rowspan - hw.length + 1);
                                    rows[index2].appendChild(hwCell);
                                    index2++
                                    if (rows.length <= index2)
                                        rows.push(document.createElement("tr"));
                                }
                                if (hw.length == 0) {
                                    var hwCell = document.createElement("td");
                                    hwCell.setAttribute("rowspan", rowspan);
                                    rows[index2].appendChild(hwCell);
                                }
                            }
                            index = rows.length - 1;
                            if (name.homework.length == 0) {
                                rows.push(document.createElement("tr"));
                                index++;
                            }
                        })
                        var noteCell = document.createElement("td");
                        noteCell.textContent = "";
                        noteCell.setAttribute("rowspan", totalHomeworkCount);
                        rows[0].appendChild(noteCell);
                        for (var i = 0; i < rows.length - 1; i++) {
                            tbody.appendChild(rows[i]);
                        }

                    });
                });
            });
        });
    </script>

</body>

</html>